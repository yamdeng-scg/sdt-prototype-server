<?xml version="1.0" encoding="UTF-8" ?>
<querys>
	<query id="getCurrentTimeStats">
		<![CDATA[
			SELECT 
				COUNT(*) AS ing_count, 
				SUM(
					CASE WHEN r.member_id IS NULL THEN 1 ELSE 0 end
				) AS ready_count, 
				(
					SELECT 
						COUNT(id) AS cnt 
					FROM 
						chat_message 
					WHERE 
						id = r.join_message_id 
						AND DATE_FORMAT(create_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
				) AS new_count, 
				(
					SELECT 
						COUNT(DISTINCT room_id) 
					FROM 
						room_join_history 
					WHERE 
						company_id = :companyId 
						AND DATE_FORMAT(create_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
				) AS end_count, 
				(
					SELECT 
						COUNT(DISTINCT room_id) 
					FROM 
						room_join_history 
					WHERE 
						company_id = :companyId 
						AND DATE_FORMAT(create_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d') 
						AND (member_id IS NULL)
				) AS out_count 
			FROM 
				room r 
			WHERE 
				company_id = :companyId 
				AND state < 2
		]]>
	</query>
	<query id="findReadyState">
		<![CDATA[
			SELECT 
				sub_room.*, 
				chat_message.id AS last_message_id, 
				chat_message.message AS last_message, 
				chat_message.create_date AS last_message_create_date, 
				v_customer.name AS customer_name,
				v_customer.is_block AS is_block_customer,
				c.name as company_name
			FROM 
				(
					SELECT 
						r.*, 
						IFNULL(
							(
								SELECT 
									create_date 
								FROM 
									chat_message 
								WHERE 
									id = r.join_message_id
							), 
							r.create_date
						) AS join_start_date, 
						(
							SELECT 
								MAX(id) 
							FROM 
								chat_message 
							WHERE 
								room_id = r.id
						) AS recent_message_id, 
						(
							SELECT 
								speaker2.id 
							FROM 
								room_speaker 
								INNER JOIN speaker2 ON room_speaker.speaker_id = speaker2.id 
							WHERE 
								room_id = r.id 
								AND speaker2.is_customer = 1
						) AS customer_speaker_id,
						(
							SELECT 
								COUNT(DISTINCT chat_message.id) 
							FROM 
								chat_message 
								INNER JOIN message_read ON chat_message.id = message_read.message_id 
							WHERE 
								chat_message.room_id = r.id 
								AND chat_message.is_employee = 0 
								AND message_read.speaker_id != chat_message.speaker_id 
								AND message_read.read_date IS NULL 
								AND chat_message.id > (
									SELECT 
										MAX(id) 
									FROM 
										chat_message 
									WHERE 
										is_employee = 1 
										AND room_id = r.id
								)
						) AS notReadCount, 
						(
							SELECT 
								MIN(chat_message.create_date) 
							FROM 
								chat_message 
								INNER JOIN message_read ON chat_message.id = message_read.message_id 
							WHERE 
								chat_message.room_id = r.id 
								AND chat_message.is_employee = 0 
								AND message_read.speaker_id != chat_message.speaker_id 
								AND message_read.read_date IS NULL 
								AND chat_message.id > (
									SELECT 
										MAX(id) 
									FROM 
										chat_message 
									WHERE 
										is_employee = 1 
										AND room_id = r.id
								)
						) AS wait_start_date,
						mb.name as member_name
					FROM 
						room r
						LEFT OUTER JOIN member mb ON r.last_member_id = mb.id
						           			AND mb.name LIKE concat('%', :memberName, '%')
						INNER JOIN (
							SELECT 
								DISTINCT(room_id), 
								room_id AS message_search_room_id 
							FROM 
								chat_message 
							WHERE 
								is_system_message = 0
								AND message_admin_type = 0 
								AND message LIKE concat('%', :message, '%')
						) messasge_search ON r.id = messasge_search.message_search_room_id
					WHERE 
						r.company_id = :companyId
						AND r.state < 2 
						AND r.member_id is null
				) AS sub_room 
				LEFT OUTER JOIN chat_message ON sub_room.recent_message_id = chat_message.id 
				INNER JOIN v_customer ON sub_room.customer_speaker_id = v_customer.speaker_id
				INNER JOIN company c ON sub_room.company_id = c.id
			WHERE 
				v_customer.company_id = :companyId
				AND v_customer.name LIKE concat('%', :customerName, '%')
			ORDER BY :sort
		]]>
	</query>
	<query id="findIngState">
		<![CDATA[
			SELECT 
				sub_room.*, 
				chat_message.id AS last_message_id, 
				chat_message.message AS last_message, 
				chat_message.create_date AS last_message_create_date, 
				v_customer.name AS customer_name,
				v_customer.is_block AS is_block_customer,
				c.name as company_name
			FROM 
				(
					SELECT 
						r.*, 
						IFNULL(
							(
								SELECT 
									create_date 
								FROM 
									chat_message 
								WHERE 
									id = r.join_message_id
							), 
							r.create_date
						) AS join_start_date, 
						(
							SELECT 
								MAX(id) 
							FROM 
								chat_message 
							WHERE 
								room_id = r.id
						) AS recent_message_id, 
						(
							SELECT 
								speaker2.id 
							FROM 
								room_speaker 
								INNER JOIN speaker2 ON room_speaker.speaker_id = speaker2.id 
							WHERE 
								room_id = r.id 
								AND speaker2.is_customer = 1
						) AS customer_speaker_id, 
						(
							SELECT 
								COUNT(DISTINCT chat_message.id) 
							FROM 
								chat_message 
								INNER JOIN message_read ON chat_message.id = message_read.message_id 
							WHERE 
								chat_message.room_id = r.id 
								AND chat_message.is_employee = 0 
								AND message_read.speaker_id != chat_message.speaker_id 
								AND message_read.read_date IS NULL 
								AND chat_message.id > (
									SELECT 
										MAX(id) 
									FROM 
										chat_message 
									WHERE 
										is_employee = 1 
										AND room_id = r.id
								)
						) AS notReadCount, 
						(
							SELECT 
								MIN(chat_message.create_date) 
							FROM 
								chat_message 
								INNER JOIN message_read ON chat_message.id = message_read.message_id 
							WHERE 
								chat_message.room_id = r.id 
								AND chat_message.is_employee = 0 
								AND message_read.speaker_id != chat_message.speaker_id 
								AND message_read.read_date IS NULL 
								AND chat_message.id > (
									SELECT 
										MAX(id) 
									FROM 
										chat_message 
									WHERE 
										is_employee = 1 
										AND room_id = r.id
								)
						) AS wait_start_date,
						mb.name as member_name
					FROM 
						room r
						INNER JOIN member mb ON r.member_id = mb.id
						INNER JOIN (
							SELECT 
								DISTINCT(room_id), 
								room_id AS message_search_room_id 
							FROM 
								chat_message 
							WHERE 
								is_system_message = 0
								AND message_admin_type = 0 
								AND message LIKE concat('%', :message, '%')
						) messasge_search ON r.id = messasge_search.message_search_room_id
					WHERE 
						r.company_id = :companyId 
						AND r.state < 2 
						AND (
							CASE WHEN :memberId IS NULL THEN 1 = 1 ELSE member_id = :memberId END
						)
						AND mb.name LIKE concat('%', :memberName, '%')
				) AS sub_room 
				LEFT OUTER JOIN chat_message ON sub_room.recent_message_id = chat_message.id 
				INNER JOIN v_customer ON sub_room.customer_speaker_id = v_customer.speaker_id
				INNER JOIN company c ON sub_room.company_id = c.id
			WHERE 
				v_customer.company_id = :companyId
				AND v_customer.name LIKE concat('%', :customerName, '%')
			ORDER BY 
				last_message_create_date DESC
		]]>
	</query>
	<query id="findSearchCloseState">
		<![CDATA[
			SELECT 
				sub_room.*, 
				chat_message.id AS last_message_id, 
				chat_message.message AS last_message, 
				chat_message.create_date AS last_message_create_date, 
				v_customer.name AS customer_name 
			FROM 
				(
					SELECT 
						r.*, 
						IFNULL(
							(
								SELECT 
									create_date 
								FROM 
									chat_message 
								WHERE 
									id = r.join_message_id
							), 
							r.create_date
						) AS join_start_date, 
						(
							SELECT 
								MAX(id) 
							FROM 
								chat_message 
							WHERE 
								room_id = r.id
						) AS recent_message_id, 
						(
							SELECT 
								speaker2.id 
							FROM 
								room_speaker 
								INNER JOIN speaker2 ON room_speaker.speaker_id = speaker2.id 
							WHERE 
								room_id = r.id 
								AND speaker2.is_customer = 1
						) AS customer_speaker_id,
						mb.name as member_name
					FROM 
						room r
						INNER JOIN (
							SELECT 
								DISTINCT(room_id), 
								room_id AS message_search_room_id 
							FROM 
								chat_message 
							WHERE 
								is_system_message = 0
								AND message_admin_type = 0 
								AND message LIKE concat('%', :message, '%')
						) messasge_search ON r.id = messasge_search.message_search_room_id
						LEFT OUTER JOIN member mb ON r.last_member_id = mb.id
														AND mb.name LIKE concat('%', :memberName, '%')
					WHERE 
						r.company_id = :companyId 
						AND r.state = 8
						AND (
							CASE WHEN :memberId is null THEN 1 = 1 ELSE last_member_id = :memberId END
						) 
						AND date_format(end_date, '%Y-%m-%d') BETWEEN :startDate 
						AND :endDate
				) AS sub_room 
				LEFT OUTER JOIN chat_message ON sub_room.recent_message_id = chat_message.id 
				INNER JOIN v_customer ON sub_room.customer_speaker_id = v_customer.speaker_id 
			WHERE 
				v_customer.company_id = :companyId
				AND v_customer.name LIKE concat('%', :customerName, '%')
			ORDER BY 
				last_message_create_date DESC
		]]>
	</query>
	<query id="findSearchJoinHistory">
		<![CDATA[
			SELECT 
				rjh.create_date AS join_start_date, 
				TIMESTAMPDIFF(
					MINUTE, rjh.create_date, rjh.end_date
				) diff_minute, 
				rjh.*, 
				mb.name AS member_name 
			FROM 
				room_join_history rjh 
				INNER JOIN chat_message m ON rjh.start_message_id = m.id 
				LEFT JOIN member mb ON mb.id = rjh.member_id 
				LEFT JOIN speaker2 sp ON mb.speaker_id = sp.id 
			WHERE 
				rjh.room_id = :roomId 
				AND rjh.end_date IS NOT NULL 
				AND rjh.room_id IN(
					SELECT 
						DISTINCT room_id 
					FROM 
						chat_message 
					WHERE 
						room_id = :roomId 
						AND id BETWEEN rjh.start_message_id 
						AND rjh.end_message_id 
						AND is_system_message = 0 
						AND message_admin_type = 0 
						AND message LIKE CONCAT('%', :message, '%')
				) 
			ORDER BY 
				rjh.id DESC
		]]>
	</query>
	<query id="closeRoom">
    CALL close_room(:roomId)
	</query>
	<query id="transfeRoom">
    CALL transfer_room(:type, :roomId, :memberId)
	</query>
	<query id="matchRoom">
    CALL match_room(:roomId, :memberId)
	</query>
	<query id="getDetail">
		<![CDATA[
			SELECT 
				sub_room.*, 
				chat_message.id AS last_message_id, 
				chat_message.message AS last_message, 
				chat_message.create_date AS last_message_create_date, 
				v_customer.name AS customer_name 
			FROM 
				(
					SELECT 
						r.*, 
						IFNULL(
							(
								SELECT 
									create_date 
								FROM 
									chat_message 
								WHERE 
									id = r.join_message_id
							), 
							r.create_date
						) AS join_start_date, 
						(
							SELECT 
								MAX(id) 
							FROM 
								chat_message 
							WHERE 
								room_id = r.id
						) AS recent_message_id, 
						(
							SELECT 
								speaker2.id 
							FROM 
								room_speaker 
								INNER JOIN speaker2 ON room_speaker.speaker_id = speaker2.id 
							WHERE 
								room_id = r.id 
								AND speaker2.is_customer = 1
						) AS customer_speaker_id,
						(
							SELECT 
								COUNT(DISTINCT chat_message.id) 
							FROM 
								chat_message 
								INNER JOIN message_read ON chat_message.id = message_read.message_id 
							WHERE 
								chat_message.room_id = r.id 
								AND chat_message.is_employee = 0 
								AND message_read.speaker_id != chat_message.speaker_id 
								AND message_read.read_date IS NULL 
								AND chat_message.id > (
									SELECT 
										MAX(id) 
									FROM 
										chat_message 
									WHERE 
										is_employee = 1 
										AND room_id = r.id
								)
						) AS notReadCount, 
						(
							SELECT 
								MIN(chat_message.create_date) 
							FROM 
								chat_message 
								INNER JOIN message_read ON chat_message.id = message_read.message_id 
							WHERE 
								chat_message.room_id = r.id 
								AND chat_message.is_employee = 0 
								AND message_read.speaker_id != chat_message.speaker_id 
								AND message_read.read_date IS NULL 
								AND chat_message.id > (
									SELECT 
										MAX(id) 
									FROM 
										chat_message 
									WHERE 
										is_employee = 1 
										AND room_id = r.id
								)
						) AS wait_start_date
					FROM 
						room r 
					WHERE 
						id = :id
				) AS sub_room
				LEFT OUTER JOIN chat_message ON sub_room.recent_message_id = chat_message.id 
				INNER JOIN v_customer ON sub_room.customer_speaker_id = v_customer.speaker_id
		]]>
	</query>
	<query id="joinRoom">
    CALL join_room(:roomId, :speakerId)
	</query>
	<query id="closeRoom">
    CALL close_room(:id) 
	</query>
	<query id="transferRoom">
    CALL transfer_room(:type, :roomId, :memberId) 
	</query>
	<query id="matchRoom">
    CALL match_room(:roomId, :memberId)
	</query>
	<query id="updateOnline">
    UPDATE room 
			SET    is_online = :isOnline 
			WHERE  id = :id 
	</query>
	<query id="getDetailBySpeakerId">
    SELECT *
			FROM  room 
			WHERE id = (SELECT room_id 
										FROM   room_speaker 
									WHERE speaker_id = :speakerId) 
	</query>
	<query id="updateJoinHistory">
    UPDATE room 
			SET  join_history_json = :history 
			WHERE id = :roomId
	</query>
	<query id="getRoomJoinHistoryDetail">
    SELECT *
			FROM   room_join_history 
			WHERE  id = :id
	</query>
	<query id="findSearchRangeById">
    SELECT * 
			FROM   chat_messaage 
			WHERE  room_id = :roomId
			AND    id BETWEEN :startId AND :endId 
			AND    is_system_message = 0 
			AND    message_admin_type = 0
	</query>
</querys>