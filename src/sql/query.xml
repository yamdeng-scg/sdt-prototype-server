<?xml version="1.0" encoding="UTF-8" ?>
<querys>
  <query id="">
		SELECT 
			ing_room.*, 
			chat_message.id AS last_message_id, 
			chat_message.message AS last_message, 
			chat_message.create_date AS last_message_create_date, 
			v_customer.name AS customer_name 
		FROM 
			(
				SELECT 
					r.*, 
					IFNULL(
						(
							SELECT 
								create_date 
							FROM 
								chat_message 
							WHERE 
								id = r.join_message_id
						), 
						r.create_date
					) AS join_start_date, 
					(
						SELECT 
							MAX(id) 
						FROM 
							chat_message 
						WHERE 
							room_id = r.id
					) AS recent_message_id, 
					(
						SELECT 
							speaker2.id 
						FROM 
							room_speaker 
							INNER JOIN speaker2 ON room_speaker.speaker_id = speaker2.id 
						WHERE 
							room_id = r.id 
							AND speaker2.is_customer = 1
					) AS customer_speaker_id 
				FROM 
					room r 
				WHERE 
					company_id = '1' 
					AND state < 2
			) AS ing_room 
			LEFT OUTER JOIN chat_message ON ing_room.recent_message_id = chat_message.id 
			INNER JOIN v_customer ON ing_room.customer_speaker_id = v_customer.speaker_id 
		WHERE 
			v_customer.company_id = '1' 
		ORDER BY 
			ing_room.state, 
			last_message_create_date DESC
  </query>
</user>