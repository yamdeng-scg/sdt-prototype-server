<?xml version="1.0" encoding="UTF-8" ?>
<querys>
  <query id="getCompany">
    SELECT * 
      FROM   company 
      WHERE  id = :id
  </query>
  <query id="getTodayWiseSay">
    SELECT * 
      FROM   wise_say 
      LIMIT  1 
  </query>
  <query id="getTodayWiseSay">
    SELECT * 
      FROM   wise_say 
      LIMIT  1 
  </query>

  <!-- 
    진행중이 룸 목록
    
    -->
  <query id="findIngRoom">
		SELECT 
			ing_room.*, 
			chat_message.id AS last_message_id, 
			chat_message.message AS last_message, 
			chat_message.create_date AS last_message_create_date, 
			v_customer.name AS customer_name 
		FROM 
			(
				SELECT 
					r.*, 
					IFNULL(
						(
							SELECT 
								create_date 
							FROM 
								chat_message 
							WHERE 
								id = r.join_message_id
						), 
						r.create_date
					) AS join_start_date, 
					(
						SELECT 
							MAX(id) 
						FROM 
							chat_message 
						WHERE 
							room_id = r.id
					) AS recent_message_id, 
					(
						SELECT 
							speaker2.id 
						FROM 
							room_speaker 
							INNER JOIN speaker2 ON room_speaker.speaker_id = speaker2.id 
						WHERE 
							room_id = r.id 
							AND speaker2.is_customer = 1
					) AS customer_speaker_id 
				FROM 
					room r 
				WHERE 
					company_id = :companyId
					AND state < 2
					AND (CASE 
					       WHEN :member_id is null THEN 1=1
                        ELSE member_id = :member_id
                END)
			) AS ing_room 
			LEFT OUTER JOIN chat_message ON ing_room.recent_message_id = chat_message.id 
			INNER JOIN v_customer ON ing_room.customer_speaker_id = v_customer.speaker_id 
		WHERE 
			v_customer.company_id = :companyId
		ORDER BY 
			ing_room.state, 
			last_message_create_date DESC
  </query>
</user>